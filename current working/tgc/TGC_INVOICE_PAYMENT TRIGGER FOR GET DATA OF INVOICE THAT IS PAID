CREATE OR REPLACE TRIGGER AP_CHECK_BTR_PAYEMENTS
  AFTER UPDATE OR INSERT ON AP_CHECKS_ALL
  REFERENCING NEW AS New OLD AS Old
  FOR EACH ROW
DECLARE

  V_BTR_ID   NUMBER;
  TT_GL_DATE AP_INVOICES_ALL.GL_DATE%TYPE;
BEGIN
  --  ====================== BTR PAYMENT =========================
  BEGIN

    SELECT TEBH.BTR_ID, AIA.GL_DATE
      INTO V_BTR_ID, TT_GL_DATE
      FROM AP_INVOICE_PAYMENTS_ALL AIPA,
           AP_INVOICES_ALL         AIA,
           AP_SUPPLIERS            ASA,
           TGC_EXP_BTR_HEADER      TEBH

     WHERE 1 = 1
       AND AIPA.INVOICE_ID = AIA.INVOICE_ID
       AND AIA.VENDOR_ID = ASA.VENDOR_ID
       AND AIPA.ACCRUAL_POSTED_FLAG = 'N'
       AND POSTED_FLAG = 'N'
       AND AIA.ATTRIBUTE9 = TEBH.BTR_ID
       AND AIA.ORG_ID = TEBH.OPERATING_UNIT
       and aia.ATTRIBUTE_CATEGORY = 'Imprest Information'
       and aia.SOURCE = 'BTR_INV'
       and aipa.CHECK_ID = :new.check_id;

    UPDATE tgc_exp_btr_header
       SET PI_PAYMENT_NUMBER = :NEW.CHECK_NUMBER,
           PI_PAYMENT_DATE   = TT_GL_DATE,
           BTR_PAYMENT       = 'Paid'
     WHERE BTR_ID = v_btr_id;

  EXCEPTION
    WHEN OTHERS THEN
      NULL;
  END;

  --- ===================== BTR EXCESS CHASH PAYMENT =============

  BEGIN

    SELECT TEBH.BTR_ID, AIA.GL_DATE
      INTO V_BTR_ID, TT_GL_DATE
      FROM AP_INVOICE_PAYMENTS_ALL AIPA,
           AP_INVOICES_ALL         AIA,
           AP_SUPPLIERS            ASA,
           TGC_EXP_BTR_HEADER      TEBH

     WHERE 1 = 1
       AND AIPA.INVOICE_ID = AIA.INVOICE_ID
       AND AIA.VENDOR_ID = ASA.VENDOR_ID
       AND AIPA.ACCRUAL_POSTED_FLAG = 'N'
       AND POSTED_FLAG = 'N'
       AND AIA.ORG_ID = TEBH.OPERATING_UNIT
       AND AIA.INVOICE_NUM = EXC_INVOICE_NUMBER
       and aipa.CHECK_ID = :new.check_id;

    UPDATE tgc_exp_btr_header
       SET EXC_PAYMENT_NUMBER  = :NEW.CHECK_NUMBER,
           EXC_INVOICE_GL_DATE = TT_GL_DATE,
           BTR_PAYMENT         = 'Paid'
     WHERE BTR_ID = v_btr_id;

  EXCEPTION
    WHEN OTHERS THEN
      NULL;

  END;

END;
