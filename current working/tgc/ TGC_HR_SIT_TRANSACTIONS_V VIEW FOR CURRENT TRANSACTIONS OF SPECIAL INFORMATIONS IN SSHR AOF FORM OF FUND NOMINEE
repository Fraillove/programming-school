CREATE OR REPLACE VIEW TGC_HR_SIT_TRANSACTIONS_V AS
SELECT INQ."TRANSACTION_STEP_ID",INQ."P_ACTION",INQ."P_ANALYSIS_CRITERIA_ID",INQ."P_DATE_FROM",INQ."P_DATE_TO",INQ."P_PERSON_ID",INQ."P_OLD_ANALYSIS_CRITERIA_ID",INQ."P_ID_FLEX_NUM",
         /* IF TRANSACTION IS insert/UPDATE  THEN  THAT IS NEW PERCENTAGE */
         (
          SELECT NVL(PAC.SEGMENT6,0)
          FROM per_analysis_criteria PAC
          WHERE PAC.ANALYSIS_CRITERIA_ID=INQ.P_ANALYSIS_CRITERIA_ID
         ) NEW_PERCENTAGE ,

         /* IF TRANSACTION IS UPDATED THEN IT WILL SHOW OLD PERCENTAGE*/
         (
          SELECT NVL(PAC.SEGMENT6,0)
          FROM per_analysis_criteria PAC
          WHERE PAC.ANALYSIS_CRITERIA_ID=INQ.P_OLD_ANALYSIS_CRITERIA_ID
         ) OLD_PERCENTAGE

 FROM (
SELECT hatv.TRANSACTION_STEP_ID ,
       max(decode(NAme,'P_ACTION',hatv.VARCHAR2_VALUE))P_ACTION,
       max(decode(NAme,'P_ANALYSIS_CRITERIA_ID',hatv.NUMBER_VALUE))P_ANALYSIS_CRITERIA_ID,
       max(decode(NAme,'P_DATE_FROM',hatv.DATE_VALUE ))P_DATE_FROM,
       max(decode(NAme,'P_DATE_TO',hatv.DATE_VALUE ))P_DATE_TO,
       max(decode(NAme,'P_PERSON_ID',hatv.NUMBER_VALUE))P_PERSON_ID,
       max(decode(NAme,'P_OLD_ANALYSIS_CRITERIA_ID',hatv.NUMBER_VALUE))P_OLD_ANALYSIS_CRITERIA_ID,
       max(decode(NAme,'P_ID_FLEX_NUM',hatv.NUMBER_VALUE))P_ID_FLEX_NUM
FROM   hr_api_transaction_values hatv
WHERE  1=1
group by hatv.TRANSACTION_STEP_ID
-- P_ID_FLEX_NUM IS FLEX_NUMBER OF SPECIAL INFORMATION "FUND NOMINEE"
      HAVING max(decode(NAme,'P_ID_FLEX_NUM',hatv.NUMBER_VALUE))=50430
) inq
;
