CREATE OR REPLACE TRIGGER TGC_BTR_MIXED_INVOICE_PAY_T
  AFTER UPDATE OR INSERT ON AP_INVOICE_PAYMENTS_ALL
  REFERENCING NEW AS New OLD AS Old
  FOR EACH ROW
DECLARE

  V_BTR_ID   NUMBER;
  TT_GL_DATE AP_INVOICES_ALL.GL_DATE%TYPE;

BEGIN

  SELECT TEBH.BTR_ID, AIA.GL_DATE
    INTO V_BTR_ID, TT_GL_DATE
    FROM AP_INVOICES_ALL AIA, AP_SUPPLIERS ASA, TGC_EXP_BTR_HEADER TEBH

   WHERE 1 = 1
     AND AIA.INVOICE_ID = :NEW.INVOICE_ID
     AND AIA.VENDOR_ID = ASA.VENDOR_ID
        --  AND AIPA.ACCRUAL_POSTED_FLAG = 'N'
        --  AND POSTED_FLAG = 'N'
     AND AIA.ORG_ID = TEBH.OPERATING_UNIT
     AND AIA.INVOICE_NUM = EXC_INVOICE_NUMBER;

  UPDATE tgc_exp_btr_header
     SET EXC_PAYMENT_NUMBER =
         (SELECT ACA.CHECK_NUMBER
            FROM AP_CHECKS_ALL ACA
           WHERE ACA.CHECK_ID = :new.check_id),
         EXC_INVOICE_GL_DATE = TT_GL_DATE,
         BTR_PAYMENT         = 'Paid'
   WHERE BTR_ID = v_btr_id;

EXCEPTION
  WHEN OTHERS THEN
    NULL;

END;
